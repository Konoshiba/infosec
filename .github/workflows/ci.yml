name: CI Security Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  security-scan:
    name: Security Analysis (SAST + SCA)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # Ð¯Ð²Ð½Ð¾ Ð¿Ñ€Ð¾Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ JAVA_HOME, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¿Ñ€Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ðµ java
    - name: Export JAVA_HOME
      run: |
        echo "JAVA_HOME=${{ env.JAVA_HOME_17_X64 }}" >> $GITHUB_ENV
        echo "${{ env.JAVA_HOME_17_X64 }}/bin" >> $GITHUB_PATH
        java -version
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    # SCA: OWASP Dependency-Check Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð½Ð° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸
    - name: Run OWASP Dependency-Check
      uses: dependency-check/Dependency-Check_Action@main
      continue-on-error: true
      env:
        DC_NVD_API_KEY: ${{ secrets.NVD_API_KEY }} # Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð·Ð°Ð´Ð°Ñ‚ÑŒ ÑÐµÐºÑ€ÐµÑ‚ NVD_API_KEY
      with:
        project: 'infosec-api'
        path: '.'
        format: 'ALL'
        out: 'reports'
        args: >
          --enableRetired
          --enableExperimental
          --failOnCVSS 7
          --suppression dependency-check-suppressions.xml
          --nvdApiKey ${{ secrets.NVD_API_KEY }}

    - name: Upload Dependency-Check reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-check-reports
        path: reports/
        retention-days: 30
        if-no-files-found: ignore
        
    # SAST: ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
    - name: Build with Maven
      run: mvn -U clean compile -DskipTests -Ddependency-check.skip=true
      
    # SAST: Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²
    - name: Run tests
      run: mvn -U test -Ddependency-check.skip=true
      continue-on-error: true
      
    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: target/surefire-reports/
        retention-days: 30
        
    # SAST: SpotBugs Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° ÐºÐ¾Ð´Ð°
    - name: Run SpotBugs Analysis
      run: |
        mvn -U com.github.spotbugs:spotbugs-maven-plugin:4.8.5:check -Ddependency-check.skip=true
      continue-on-error: true
      
    - name: Upload SpotBugs reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: spotbugs-reports
        path: target/spotbugsXml.xml
        retention-days: 30
        if-no-files-found: ignore
        
    # SAST: PMD Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°
    - name: Run PMD Analysis
      run: |
        mvn -U pmd:check -Ddependency-check.skip=true
      continue-on-error: true
      
    - name: Upload PMD reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pmd-reports
        path: target/pmd.xml
        retention-days: 30
        if-no-files-found: ignore
        
    # SAST: Checkstyle Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÑ‚Ð¸Ð»Ñ ÐºÐ¾Ð´Ð°
    - name: Run Checkstyle Analysis
      run: |
        mvn -U checkstyle:check -Ddependency-check.skip=true
      continue-on-error: true
      
    - name: Upload Checkstyle reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: checkstyle-reports
        path: target/checkstyle-result.xml
        retention-days: 30
        if-no-files-found: ignore
        
    # Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ
    - name: Security Scan Summary
      if: always()
      run: |
        echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### SAST Tools:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… SpotBugs: Static code analysis" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… PMD: Code quality analysis" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Checkstyle: Code style analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### SCA Tools:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… OWASP Dependency-Check: Vulnerability scanning" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Ð’ÑÐµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð² Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°Ñ… ÑÐ±Ð¾Ñ€ÐºÐ¸" >> $GITHUB_STEP_SUMMARY
