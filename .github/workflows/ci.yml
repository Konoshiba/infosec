name: CI Security Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  security-scan:
    name: Security Analysis (SAST + SCA)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run OWASP Dependency-Check with Maven
      run: |
        mvn org.owasp:dependency-check-maven:check \
          -Dnvd.api.key=${{ secrets.NVD_API_KEY }} \
          -Ddependency-check.failBuildOnCVSS=7 \
          -Ddependency-check.enableRetired=true \
          -Ddependency-check.enableExperimental=true \
          -Ddependency-check.suppressionFile=dependency-check-suppressions.xml \
          -Ddependency-check.formats=HTML,XML,JSON,CSV
      continue-on-error: true

    - name: Upload Dependency-Check reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-check-reports
        path: target/dependency-check-report.*
        retention-days: 30
        if-no-files-found: ignore
        
    # SAST: Компиляция проекта
    - name: Build with Maven
      run: mvn -U clean compile -DskipTests -Ddependency-check.skip=true
        
    # SAST: SpotBugs для статического анализа кода
    - name: Run SpotBugs Analysis
      run: |
        mvn -U com.github.spotbugs:spotbugs-maven-plugin:4.9.8.2:check -Ddependency-check.skip=true
      continue-on-error: true
      
    - name: Upload SpotBugs reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: spotbugs-reports
        path: target/spotbugsXml.xml
        retention-days: 30
        if-no-files-found: ignore
        
    # SAST: PMD для анализа качества кода
    - name: Run PMD Analysis
      run: |
        mvn -U pmd:check -Ddependency-check.skip=true
      continue-on-error: true
      
    - name: Upload PMD reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pmd-reports
        path: target/pmd.xml
        retention-days: 30
        if-no-files-found: ignore
        
    # SAST: Checkstyle для проверки стиля кода
    - name: Run Checkstyle Analysis
      run: |
        mvn -U checkstyle:check -Ddependency-check.skip=true
      continue-on-error: true
      
    - name: Upload Checkstyle reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: checkstyle-reports
        path: target/checkstyle-result.xml
        retention-days: 30
        if-no-files-found: ignore
        
    # Итоговый статус
    - name: Security Scan Summary
      if: always()
      run: |
        echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### SAST Tools:" >> $GITHUB_STEP_SUMMARY
        echo "- SpotBugs: Static code analysis" >> $GITHUB_STEP_SUMMARY
        echo "- PMD: Code quality analysis" >> $GITHUB_STEP_SUMMARY
        echo "- Checkstyle: Code style analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### SCA Tools:" >> $GITHUB_STEP_SUMMARY
        echo "- OWASP Dependency-Check: Vulnerability scanning" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Все отчеты доступны в артефактах сборки" >> $GITHUB_STEP_SUMMARY
